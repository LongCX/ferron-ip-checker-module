# .github/workflows/ferron-static-build.yml
name: Ferron module static build

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-static:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1. Checkout module (repo hiện tại)
      - name: Checkout module repository
        uses: actions/checkout@v4
        with:
          path: module

      # 2. Checkout Ferron 2.x (develop-2.x)
      - name: Checkout Ferron repository
        uses: actions/checkout@v4
        with:
          repository: ferronweb/ferron
          ref: develop-2.x
          path: ferron

      - name: Install musl tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            musl-tools musl-dev \
            build-essential \
            pkg-config \
            libssl-dev

      # 3. Cài Rust + target musl (để build static)
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-musl

      # 4. Cache Rust (target riêng cho musl để tránh xung đột với gnu)
      - name: Cache cargo registry & build output
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ferron -> target
            module -> target

      # 5. Tạo override config để thêm module
      - name: Create Ferron compile-time configuration overrides
        run: cp ferron/ferron-build.yaml ferron/ferron-build-override.yaml

      # 6. Thêm module của bạn vào sau CoreModuleLoader (theo đúng khuyến nghị)
      - name: Inject module into config
        uses: mikefarah/yq@master
        with:
          cmd: |
            yq -i '.modules |= (
                  (.[] | select(
                    .loader == "ReplaceModuleLoader"
                  ) | key + 1) as $pos |
                  .[:$pos] +
                  [
                    {
                      "path": "${{ github.workspace }}/module",
                      "crate": "ferron-module-ip-block",
                      "loader": "IpBlockModuleLoader"
                    }
                  ] +
                  .[$pos:])' ferron/ferron-build-override.yaml

      # 7. Build Ferron + module → binary 100% static
      - name: Build Ferron (fully static musl)
        env:
          # Bắt buộc bật vendored cho openssl và aws-lc để static
          OPENSSL_DIR: /usr
          OPENSSL_STATIC: "1"
          OPENSSL_LIB_DIR: /usr/lib/x86_64-linux-gnu
          OPENSSL_INCLUDE_DIR: /usr/include
          # Fix aws-lc-sys khi cross musl
          CC_x86_64_unknown_linux_musl: x86_64-linux-musl-gcc
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER: x86_64-linux-musl-gcc
          # Force dùng vendored openssl thay vì hệ thống
          OPENSSL_NO_VENDOR: 0
        run: |
          cd ferron

          # Chuẩn bị workspace như Ferron yêu cầu
          cargo run --manifest-path build-prepare/Cargo.toml

          cd build-workspace

          export CC_x86_64_unknown_linux_musl=x86_64-linux-musl-gcc
          export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=x86_64-linux-musl-gcc

          # Giải quyết xung đột phiên bản (nếu có) – giữ nguyên logic cũ nhưng an toàn hơn
          while true; do
            CONFLICTS=$(cargo tree -i ferron-core -e normal --duplicates 2>/dev/null | grep -v "ferron-core" || true)
            if [[ -z "$CONFLICTS" ]]; then
              break
            fi
            echo "Resolving duplicate dependencies..."
            cargo update --aggressive
          done

          # Build static release
          cargo build --release --target x86_64-unknown-linux-musl

          # Copy binary ra ngoài để dễ artifact
          mkdir -p ../../artifacts
          find target/x86_64-unknown-linux-musl/release \
            -maxdepth 1 -type f -executable \
            -exec cp {} ../../artifacts/ \;

      # 8. Kiểm tra binary thật sự static chưa (ldd phải báo "statically linked")
      - name: Verify binary is static
        run: |
          file artifacts/* | grep "statically linked" || (echo "Binary không phải static!" && exit 1)
          ldd artifacts/* 2>&1 | grep "statically linked" || (echo "ldd báo không static!" && exit 1)
          echo "Binary đã được build 100% static thành công!"

      # 9. Upload tất cả binary static (ferron, ferrond, ferron-cli, v.v.)
      - name: Upload static binaries
        uses: actions/upload-artifact@v4
        with:
          name: ferron-module-ip-block-static-binaries
          path: artifacts/*
          if-no-files-found: error
